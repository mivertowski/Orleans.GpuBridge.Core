using Microsoft.Extensions.Logging;
using Orleans;
using Orleans.GpuBridge.Abstractions.Capacity;
using Orleans.GpuBridge.Runtime;
using Orleans.Runtime;
using Orleans.Runtime.Placement;
using System.Net;

namespace Orleans.GpuBridge.Tests.RC2.Runtime;

/// <summary>
/// Comprehensive test suite for GPU placement strategies including GpuPlacementDirector and GpuPlacementStrategy.
/// 60 tests covering placement logic, GPU capacity queries, fallback scenarios, and concurrent placement.
/// </summary>
public sealed class PlacementStrategyTests : IDisposable
{
    private readonly Mock<ILogger<GpuPlacementDirector>> _mockLogger;
    private readonly Mock<IGrainFactory> _mockGrainFactory;
    private readonly Mock<IPlacementContext> _mockPlacementContext;
    private readonly Mock<IGpuCapacityGrain> _mockCapacityGrain;
    private readonly CancellationTokenSource _cts;

    public PlacementStrategyTests()
    {
        _mockLogger = new Mock<ILogger<GpuPlacementDirector>>();
        _mockGrainFactory = new Mock<IGrainFactory>();
        _mockPlacementContext = new Mock<IPlacementContext>();
        _mockCapacityGrain = new Mock<IGpuCapacityGrain>();
        _cts = new CancellationTokenSource();

        // Setup default capacity grain
        _mockGrainFactory.Setup(f => f.GetGrain<IGpuCapacityGrain>(It.IsAny<long>(), It.IsAny<string>()))
            .Returns(_mockCapacityGrain.Object);
    }

    public void Dispose()
    {
        _cts?.Dispose();
    }

    #region GpuPlacementStrategy Tests (10 tests)

    [Fact]
    public void GpuPlacementStrategy_Instance_IsSingleton()
    {
        // Arrange & Act
        var instance1 = GpuPlacementStrategy.Instance;
        var instance2 = GpuPlacementStrategy.Instance;

        // Assert
        instance1.Should().BeSameAs(instance2);
    }

    [Fact]
    public void GpuPlacementStrategy_DefaultValues_AreCorrect()
    {
        // Arrange & Act
        var strategy = GpuPlacementStrategy.Instance;

        // Assert
        strategy.PreferLocalPlacement.Should().BeFalse();
        strategy.MinimumGpuMemoryMB.Should().Be(0);
    }

    [Fact]
    public void GpuPlacementStrategy_WithCustomValues_PreservesSettings()
    {
        // Arrange & Act
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };

        // Assert
        strategy.PreferLocalPlacement.Should().BeTrue();
        strategy.MinimumGpuMemoryMB.Should().Be(2048);
    }

    [Fact]
    public void GpuPlacementStrategy_WithZeroMemory_IsValid()
    {
        // Arrange & Act
        var strategy = new GpuPlacementStrategy
        {
            MinimumGpuMemoryMB = 0
        };

        // Assert
        strategy.MinimumGpuMemoryMB.Should().Be(0);
    }

    [Fact]
    public void GpuPlacementStrategy_WithLargeMemory_IsValid()
    {
        // Arrange & Act
        var strategy = new GpuPlacementStrategy
        {
            MinimumGpuMemoryMB = 32768 // 32GB
        };

        // Assert
        strategy.MinimumGpuMemoryMB.Should().Be(32768);
    }

    [Fact]
    public void GpuPlacementStrategy_Serialization_PreservesData()
    {
        // Arrange
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 4096
        };

        // Act - Serialize and deserialize
        var json = System.Text.Json.JsonSerializer.Serialize(strategy);
        var deserialized = System.Text.Json.JsonSerializer.Deserialize<GpuPlacementStrategy>(json);

        // Assert
        deserialized.Should().NotBeNull();
        deserialized!.PreferLocalPlacement.Should().Be(true);
        deserialized.MinimumGpuMemoryMB.Should().Be(4096);
    }

    [Fact]
    public void GpuPlacementStrategy_Equality_WorksCorrectly()
    {
        // Arrange
        var strategy1 = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };

        var strategy2 = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };

        // Act & Assert
        // Note: GpuPlacementStrategy doesn't implement IEquatable, so this tests reference equality
        strategy1.Should().NotBeSameAs(strategy2);
    }

    [Fact]
    public void GpuPlacementStrategy_InheritanceCheck_IsPlacementStrategy()
    {
        // Arrange & Act
        var strategy = GpuPlacementStrategy.Instance;

        // Assert
        strategy.Should().BeAssignableTo<PlacementStrategy>();
    }

    [Fact]
    public void GpuPlacementStrategy_WithNegativeMemory_StillValid()
    {
        // Arrange & Act - The type system allows negative values
        var strategy = new GpuPlacementStrategy
        {
            MinimumGpuMemoryMB = -1
        };

        // Assert
        strategy.MinimumGpuMemoryMB.Should().Be(-1);
    }

    [Fact]
    public void GpuPlacementStrategy_MultipleInstances_Independent()
    {
        // Arrange & Act
        var strategy1 = new GpuPlacementStrategy { MinimumGpuMemoryMB = 1024 };
        var strategy2 = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        // Assert
        strategy1.MinimumGpuMemoryMB.Should().Be(1024);
        strategy2.MinimumGpuMemoryMB.Should().Be(2048);
    }

    #endregion

    #region GpuPlacementDirector Basic Tests (12 tests)

    [Fact]
    public void GpuPlacementDirector_Constructor_WithNullLogger_ThrowsArgumentNullException()
    {
        // Arrange & Act
        var act = () => new GpuPlacementDirector(null!, _mockGrainFactory.Object);

        // Assert
        act.Should().Throw<ArgumentNullException>().WithParameterName("logger");
    }

    [Fact]
    public void GpuPlacementDirector_Constructor_WithNullGrainFactory_ThrowsArgumentNullException()
    {
        // Arrange & Act
        var act = () => new GpuPlacementDirector(_mockLogger.Object, null!);

        // Assert
        act.Should().Throw<ArgumentNullException>().WithParameterName("grainFactory");
    }

    [Fact]
    public void GpuPlacementDirector_ImplementsInterface_Correctly()
    {
        // Arrange & Act
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);

        // Assert
        director.Should().BeAssignableTo<IPlacementDirector>();
    }

    [Fact]
    public async Task OnAddActivation_WithNonGpuStrategy_SelectsFallbackSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new RandomPlacementStrategy();
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress(), CreateSiloAddress() };

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().BeOneOf(compatibleSilos);
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Warning,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("non-GPU strategy")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task OnAddActivation_WithGpuStrategy_SelectsBestGpuSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var bestSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(bestSilo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(bestSilo.SiloAddress);
    }

    [Fact]
    public async Task OnAddActivation_WithNoGpuSilos_FallsBackToCpuSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(compatibleSilos[0]);
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Warning,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("No GPU-capable silo")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task OnAddActivation_WithPreferLocal_SelectsLocalSiloWhenAvailable()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 1024
        };
        var target = CreatePlacementTarget();
        var localSilo = CreateSiloAddress();
        var remoteSilo = CreateSiloAddress();

        var localGpuInfo = CreateGpuSiloInfo(localSilo, 2048, 4096, 5);
        var remoteGpuInfo = CreateGpuSiloInfo(remoteSilo, 3072, 8192, 3);

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns(localSilo);
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(remoteGpuInfo);
        _mockCapacityGrain.Setup(g => g.GetGpuCapableSilosAsync())
            .ReturnsAsync(new[] { localGpuInfo, remoteGpuInfo });

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(localSilo);
    }

    [Fact]
    public async Task OnAddActivation_WithPreferLocal_ButInsufficientMemory_SelectsRemoteSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 4096
        };
        var target = CreatePlacementTarget();
        var localSilo = CreateSiloAddress();
        var remoteSilo = CreateSiloAddress();

        var localGpuInfo = CreateGpuSiloInfo(localSilo, 2048, 4096, 5); // Not enough memory
        var remoteGpuInfo = CreateGpuSiloInfo(remoteSilo, 6144, 8192, 3);

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns(localSilo);
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(remoteGpuInfo);
        _mockCapacityGrain.Setup(g => g.GetGpuCapableSilosAsync())
            .ReturnsAsync(new[] { localGpuInfo, remoteGpuInfo });

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(remoteSilo);
    }

    [Fact]
    public async Task OnAddActivation_WithException_FallsBackGracefully()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ThrowsAsync(new InvalidOperationException("Capacity grain error"));

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(compatibleSilos[0]);
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Error,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Error selecting GPU-capable silo")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task OnAddActivation_WithNoCompatibleSilos_ThrowsInvalidOperation()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy();
        var target = CreatePlacementTarget();

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(Array.Empty<SiloAddress>());

        // Act
        var act = async () => await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        await act.Should().ThrowAsync<InvalidOperationException>()
            .WithMessage("*No compatible silos*");
    }

    [Fact]
    public async Task OnAddActivation_LogsPlacementDecision()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var bestSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(bestSilo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Placed grain")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task OnAddActivation_WithZeroMemoryRequirement_SelectsAnyGpuSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 0 };
        var target = CreatePlacementTarget();
        var bestSilo = CreateGpuSiloInfo(CreateSiloAddress(), 1024, 2048, 5);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(0))
            .ReturnsAsync(bestSilo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(bestSilo.SiloAddress);
    }

    #endregion

    #region Advanced Placement Scenarios (15 tests)

    [Fact]
    public async Task Placement_WithHighMemoryRequirement_SelectsHighCapacitySilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 16384 }; // 16GB
        var target = CreatePlacementTarget();
        var highCapacitySilo = CreateGpuSiloInfo(CreateSiloAddress(), 20480, 24576, 2);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(16384))
            .ReturnsAsync(highCapacitySilo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(highCapacitySilo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithLowQueueDepth_PrefersLessLoadedSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();

        var silo1 = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 50); // High queue
        var silo2 = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 5);  // Low queue

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(2048))
            .ReturnsAsync(silo2); // Capacity grain should prefer low queue

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo2.SiloAddress);
    }

    [Fact]
    public async Task Placement_ConcurrentActivations_ThreadSafe()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        var silos = Enumerable.Range(0, 5).Select(_ =>
            CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10)).ToArray();

        var siloIndex = 0;
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(() => silos[Interlocked.Increment(ref siloIndex) % silos.Length]);

        // Act
        var tasks = Enumerable.Range(0, 20).Select(async _ =>
        {
            var target = CreatePlacementTarget();
            return await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);
        }).ToArray();

        var selectedSilos = await Task.WhenAll(tasks);

        // Assert
        selectedSilos.Should().HaveCount(20);
        selectedSilos.Should().OnlyContain(s => s != null);
    }

    [Fact]
    public async Task Placement_WithMultipleStrategies_HandlesCorrectly()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);

        var gpuStrategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var randomStrategy = new RandomPlacementStrategy();

        var gpuSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(gpuSilo);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var gpuTarget = CreatePlacementTarget();
        var randomTarget = CreatePlacementTarget();

        var gpuPlacement = await director.OnAddActivation(gpuStrategy, gpuTarget, _mockPlacementContext.Object);
        var randomPlacement = await director.OnAddActivation(randomStrategy, randomTarget, _mockPlacementContext.Object);

        // Assert
        gpuPlacement.Should().Be(gpuSilo.SiloAddress);
        randomPlacement.Should().Be(compatibleSilos[0]);
    }

    [Fact]
    public async Task Placement_WithDynamicCapacityChanges_AdaptsCorrectly()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        var silo1 = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);
        var silo2 = CreateGpuSiloInfo(CreateSiloAddress(), 2048, 8192, 5); // Less memory initially

        var callCount = 0;
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(() => callCount++ == 0 ? silo1 : silo2);

        // Act
        var target1 = CreatePlacementTarget();
        var target2 = CreatePlacementTarget();

        var placement1 = await director.OnAddActivation(strategy, target1, _mockPlacementContext.Object);
        var placement2 = await director.OnAddActivation(strategy, target2, _mockPlacementContext.Object);

        // Assert
        placement1.Should().Be(silo1.SiloAddress);
        placement2.Should().Be(silo2.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithSiloFailure_FallsBackToOtherSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress(), CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ThrowsAsync(new TimeoutException("Silo not responding"));

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().BeOneOf(compatibleSilos);
    }

    [Fact]
    public async Task Placement_WithPreferLocal_ButNoLocalGpu_SelectsRemote()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };
        var target = CreatePlacementTarget();
        var localSilo = CreateSiloAddress();
        var remoteSilo = CreateSiloAddress();
        var remoteGpuInfo = CreateGpuSiloInfo(remoteSilo, 4096, 8192, 5);

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns(localSilo);
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(remoteGpuInfo);
        _mockCapacityGrain.Setup(g => g.GetGpuCapableSilosAsync())
            .ReturnsAsync(new[] { remoteGpuInfo }); // Local silo not in list

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(remoteSilo);
    }

    [Fact]
    public async Task Placement_WithMultipleGpuSilos_SelectsOptimalOne()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();

        var silo1 = CreateGpuSiloInfo(CreateSiloAddress(), 3072, 8192, 20); // More memory, high queue
        var silo2 = CreateGpuSiloInfo(CreateSiloAddress(), 2560, 8192, 5);  // Less memory, low queue
        var silo3 = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 15); // Most memory, medium queue

        // Capacity grain should select based on placement score
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(2048))
            .ReturnsAsync(silo2); // Best overall score

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo2.SiloAddress);
    }

    [Fact]
    public async Task Placement_StressTest_1000Activations_Stable()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        var silos = Enumerable.Range(0, 10).Select(_ =>
            CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10)).ToArray();

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(() => silos[Random.Shared.Next(silos.Length)]);

        // Act
        var sw = System.Diagnostics.Stopwatch.StartNew();
        var tasks = Enumerable.Range(0, 1000).Select(async _ =>
        {
            var target = CreatePlacementTarget();
            return await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);
        }).ToArray();

        var selectedSilos = await Task.WhenAll(tasks);
        sw.Stop();

        // Assert
        selectedSilos.Should().HaveCount(1000);
        selectedSilos.Should().OnlyContain(s => s != null);
        sw.ElapsedMilliseconds.Should().BeLessThan(5000, "placement should be efficient");
    }

    [Fact]
    public async Task Placement_WithCapacityGrainTimeout_FallsBack()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ThrowsAsync(new TimeoutException("Capacity grain timeout"));

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(compatibleSilos[0]);
    }

    [Fact]
    public async Task Placement_WithAllSilosOverloaded_StillPlaces()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();

        var overloadedSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 1000); // Very high queue

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(overloadedSilo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(overloadedSilo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithMemoryFragmentation_SelectsBestFit()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2000 };
        var target = CreatePlacementTarget();

        var silo1 = CreateGpuSiloInfo(CreateSiloAddress(), 2048, 8192, 10); // Just fits
        var silo2 = CreateGpuSiloInfo(CreateSiloAddress(), 6144, 8192, 10); // Lots of space

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(2000))
            .ReturnsAsync(silo1); // Best fit

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo1.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithRapidSuccessiveActivations_MaintainsPerformance()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act - Rapid successive activations
        var timings = new List<long>();

        for (int i = 0; i < 100; i++)
        {
            var sw = System.Diagnostics.Stopwatch.StartNew();
            var target = CreatePlacementTarget();
            await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);
            sw.Stop();
            timings.Add(sw.ElapsedMilliseconds);
        }

        // Assert - Performance should not degrade
        var avgTime = timings.Average();
        var lastTenAvg = timings.TakeLast(10).Average();

        lastTenAvg.Should().BeLessThan(avgTime * 2, "performance should remain stable");
    }

    [Fact]
    public async Task Placement_WithNullBestSilo_HandlesGracefully()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(compatibleSilos[0]);
    }

    [Fact]
    public async Task Placement_WithEmptyGpuSilosList_FallsBack()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };
        var target = CreatePlacementTarget();
        var localSilo = CreateSiloAddress();
        var compatibleSilos = new[] { localSilo };

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns(localSilo);
        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);
        _mockCapacityGrain.Setup(g => g.GetGpuCapableSilosAsync())
            .ReturnsAsync(Array.Empty<GpuSiloInfo>());

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(localSilo);
    }

    #endregion

    #region Logging and Diagnostics Tests (10 tests)

    [Fact]
    public async Task Placement_LogsDebugInfo_WhenSelectingSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Debug,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Selecting GPU-capable silo")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_LogsInformation_OnSuccessfulPlacement()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Placed grain") &&
                                               v.ToString()!.Contains("Score") &&
                                               v.ToString()!.Contains("Memory")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_LogsWarning_WhenNoGpuSilos()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Warning,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("No GPU-capable silo found")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_LogsError_OnException()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ThrowsAsync(new InvalidOperationException("Test exception"));

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Error,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Error selecting GPU-capable silo")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_IncludesPlacementScore_InLogs()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Score:")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_IncludesMemoryInfo_InLogs()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("4096") &&
                                               v.ToString()!.Contains("8192")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_IncludesQueueDepth_InLogs()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("Queue: 10")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_WithLocalPlacement_LogsLocalSiloSelection()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 1024
        };
        var target = CreatePlacementTarget();
        var localSilo = CreateSiloAddress();
        var localGpuInfo = CreateGpuSiloInfo(localSilo, 2048, 4096, 5);

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns(localSilo);
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(localGpuInfo);
        _mockCapacityGrain.Setup(g => g.GetGpuCapableSilosAsync())
            .ReturnsAsync(new[] { localGpuInfo });

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Information,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("local")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_WithFallback_LogsFallbackReason()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                LogLevel.Debug,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains("fallback")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task Placement_LogsGrainIdentity()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        _mockLogger.Verify(
            x => x.Log(
                It.IsAny<LogLevel>(),
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString()!.Contains(target.GrainIdentity.ToString())),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.AtLeastOnce);
    }

    #endregion

    #region Edge Cases and Boundary Tests (13 tests)

    [Fact]
    public async Task Placement_WithVeryLargeQueueDepth_HandlesCorrectly()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, int.MaxValue);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithZeroAvailableMemory_StillSelects()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 0 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 0, 8192, 5);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithMaxIntMemoryRequirement_HandlesCorrectly()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = int.MaxValue };
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null); // No silo can satisfy

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(compatibleSilos[0]);
    }

    [Fact]
    public async Task Placement_WithSingleSilo_AlwaysSelectsThatSilo()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var singleSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(singleSilo);

        // Act - Place multiple grains
        var tasks = Enumerable.Range(0, 10).Select(async _ =>
        {
            var t = CreatePlacementTarget();
            return await director.OnAddActivation(strategy, t, _mockPlacementContext.Object);
        }).ToArray();

        var selectedSilos = await Task.WhenAll(tasks);

        // Assert
        selectedSilos.Should().OnlyContain(s => s.Equals(singleSilo.SiloAddress));
    }

    [Fact]
    public async Task Placement_WithNullGrainIdentity_HandlesGracefully()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().NotBeNull();
    }

    [Fact]
    public async Task Placement_WithEmptyCompatibleSilosList_Throws()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(Array.Empty<SiloAddress>());

        // Act
        var act = async () => await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        await act.Should().ThrowAsync<InvalidOperationException>()
            .WithMessage("*No compatible silos*");
    }

    [Fact]
    public async Task Placement_WithCapacityGrainReturningNull_MultipleTimes_ConsistentFallback()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var compatibleSilos = new[] { CreateSiloAddress() };

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync((GpuSiloInfo?)null);

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act
        var placements = new List<SiloAddress>();
        for (int i = 0; i < 5; i++)
        {
            var target = CreatePlacementTarget();
            var silo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);
            placements.Add(silo);
        }

        // Assert
        placements.Should().OnlyContain(s => s.Equals(compatibleSilos[0]));
    }

    [Fact]
    public async Task Placement_WithPreferLocal_AndLocalSiloNull_HandlesGracefully()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy
        {
            PreferLocalPlacement = true,
            MinimumGpuMemoryMB = 2048
        };
        var target = CreatePlacementTarget();
        var remoteSilo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 5);

        _mockPlacementContext.Setup(c => c.LocalSilo).Returns((SiloAddress)null!);
        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(remoteSilo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(remoteSilo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithVeryHighConcurrency_NoDeadlocks()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };

        var silos = Enumerable.Range(0, 3).Select(_ =>
            CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10)).ToArray();

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(() => silos[Random.Shared.Next(silos.Length)]);

        // Act
        var tasks = Enumerable.Range(0, 500).Select(async _ =>
        {
            var target = CreatePlacementTarget();
            return await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);
        }).ToArray();

        var timeout = Task.Delay(TimeSpan.FromSeconds(10));
        var completed = await Task.WhenAny(Task.WhenAll(tasks), timeout);

        // Assert
        completed.Should().NotBeSameAs(timeout, "should complete without deadlocks");
        tasks.All(t => t.IsCompleted).Should().BeTrue();
    }

    [Fact]
    public async Task Placement_WithCapacityGrainException_AndNoCompatibleSilos_Throws()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 2048 };
        var target = CreatePlacementTarget();

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ThrowsAsync(new InvalidOperationException("Capacity error"));

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(Array.Empty<SiloAddress>());

        // Act
        var act = async () => await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        await act.Should().ThrowAsync<InvalidOperationException>();
    }

    [Fact]
    public async Task Placement_WithRandomPlacementStrategy_UsesRandomSelection()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new RandomPlacementStrategy();
        var target = CreatePlacementTarget();
        var compatibleSilos = new[] { CreateSiloAddress(), CreateSiloAddress(), CreateSiloAddress() };

        _mockPlacementContext.Setup(c => c.GetCompatibleSilos(It.IsAny<PlacementTarget>()))
            .Returns(compatibleSilos);

        // Act - Place multiple grains
        var placements = new List<SiloAddress>();
        for (int i = 0; i < 10; i++)
        {
            var t = CreatePlacementTarget();
            var silo = await director.OnAddActivation(strategy, t, _mockPlacementContext.Object);
            placements.Add(silo);
        }

        // Assert - Should use one of the compatible silos
        placements.Should().OnlyContain(s => compatibleSilos.Contains(s));
    }

    [Fact]
    public async Task Placement_WithNegativeMemoryRequirement_HandledAsZero()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = -1024 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 4096, 8192, 10);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo.SiloAddress);
    }

    [Fact]
    public async Task Placement_WithAllSilosHavingZeroMemory_StillPlaces()
    {
        // Arrange
        var director = new GpuPlacementDirector(_mockLogger.Object, _mockGrainFactory.Object);
        var strategy = new GpuPlacementStrategy { MinimumGpuMemoryMB = 0 };
        var target = CreatePlacementTarget();
        var silo = CreateGpuSiloInfo(CreateSiloAddress(), 0, 0, 0);

        _mockCapacityGrain.Setup(g => g.GetBestSiloForPlacementAsync(It.IsAny<int>()))
            .ReturnsAsync(silo);

        // Act
        var selectedSilo = await director.OnAddActivation(strategy, target, _mockPlacementContext.Object);

        // Assert
        selectedSilo.Should().Be(silo.SiloAddress);
    }

    #endregion

    #region Helper Methods

    private PlacementTarget CreatePlacementTarget()
    {
        return new PlacementTarget(
            GrainId.Create("test-grain", Guid.NewGuid().ToString()),
            null,
            null);
    }

    private SiloAddress CreateSiloAddress()
    {
        return SiloAddress.New(new System.Net.IPEndPoint(System.Net.IPAddress.Loopback, Random.Shared.Next(10000, 60000)), 0);
    }

    // Mock class for GPU silo placement information
    private class GpuSiloInfo
    {
        public SiloAddress? SiloAddress { get; set; }
        public int AvailableMemoryMB { get; set; }
        public int TotalMemoryMB { get; set; }
        public int QueueDepth { get; set; }
    }

    private GpuSiloInfo CreateGpuSiloInfo(SiloAddress address, int availableMemory, int totalMemory, int queueDepth)
    {
        return new GpuSiloInfo
        {
            SiloAddress = address,
            AvailableMemoryMB = availableMemory,
            TotalMemoryMB = totalMemory,
            QueueDepth = queueDepth
        };
    }

    #endregion
}

/// <summary>
/// Random placement strategy for testing fallback behavior
/// </summary>
internal class RandomPlacementStrategy : PlacementStrategy
{
}
