using System;
using System.Threading.Tasks;
using Xunit;
using FluentAssertions;
using Orleans.GpuBridge.Abstractions;

namespace Orleans.GpuBridge.Tests.RC2.TestingFramework;

/// <summary>
/// Example tests demonstrating usage of the GPU testing framework infrastructure.
/// These tests serve as documentation and validation of the testing framework components.
/// </summary>
public sealed class ExampleUsageTest : IClassFixture<GpuTestFixture>
{
    private readonly GpuTestFixture _fixture;

    public ExampleUsageTest(GpuTestFixture fixture)
    {
        _fixture = fixture;
    }

    /// <summary>
    /// Example: Using GpuTestFixture with mock GPU provider.
    /// </summary>
    [Fact]
    public async Task Example_GpuTestFixture_WithMockProvider()
    {
        // Arrange: Configure mock provider behavior
        _fixture.ConfigureMockProvider(mock =>
        {
            mock.SimulateFailure = false;
            mock.SimulatedDelay = TimeSpan.FromMilliseconds(10);
        });

        // Act: Access GPU Bridge through fixture
        var gpuBridge = _fixture.GpuBridge;
        var devices = await gpuBridge.GetDevicesAsync();

        // Assert: Verify mock provider tracked the operation
        devices.Should().NotBeNull();
        _fixture.MockProvider.Should().NotBeNull();
    }

    /// <summary>
    /// Example: Using TestDataBuilders for float arrays.
    /// </summary>
    [Fact]
    public void Example_TestDataBuilders_FloatArray()
    {
        // Arrange: Build test data with various patterns
        var sequential = TestDataBuilders.FloatArray(100)
            .WithSequentialValues()
            .Build();

        var random = TestDataBuilders.FloatArray(100)
            .WithRandomValues()
            .WithSeed(42)
            .Build();

        var constant = TestDataBuilders.FloatArray(100)
            .WithConstantValue(5.0f)
            .Build();

        // Assert: Verify data characteristics
        sequential[0].Should().Be(0f);
        sequential[99].Should().Be(99f);
        random.Length.Should().Be(100);
        constant.Should().AllBe(5.0f);
    }

    /// <summary>
    /// Example: Using edge case data generators.
    /// </summary>
    [Fact]
    public void Example_EdgeCases_DataGeneration()
    {
        // Arrange: Generate edge case test data
        var empty = TestDataBuilders.EdgeCases.EmptyFloatArray();
        var single = TestDataBuilders.EdgeCases.SingleFloatElement(42.0f);
        var allZeros = TestDataBuilders.EdgeCases.AllZeros(100);
        var sparse = TestDataBuilders.EdgeCases.SparseArray(1000, 10);

        // Assert: Verify edge case characteristics
        empty.Should().BeEmpty();
        single.Should().Equal(42.0f);
        allZeros.Should().AllBe(0f);
        sparse.Count(x => x != 0).Should().BeLessOrEqualTo(10);
    }

    /// <summary>
    /// Example: Using approximate equality assertions for float arrays.
    /// </summary>
    [Fact]
    public void Example_GpuTestHelpers_ApproximateEquality()
    {
        // Arrange: Create arrays with small differences
        var actual = new[] { 1.0f, 2.0f, 3.0f };
        var expected = new[] { 1.000001f, 2.000001f, 3.000001f };

        // Act & Assert: Should be approximately equal
        actual.ShouldBeApproximately(expected, tolerance: 1e-5f);
    }

    /// <summary>
    /// Example: Using retry logic for flaky operations.
    /// </summary>
    [Fact]
    public async Task Example_GpuTestHelpers_RetryLogic()
    {
        // Arrange: Simulate flaky operation that fails twice then succeeds
        var attemptCount = 0;
        async Task FlakyOperation()
        {
            attemptCount++;
            if (attemptCount < 3)
                throw new InvalidOperationException("Simulated failure");
            await Task.Delay(10);
        }

        // Act: Retry with custom configuration
        await GpuTestHelpers.WithRetryAsync(
            FlakyOperation,
            maxRetries: 5,
            delayBetweenRetries: TimeSpan.FromMilliseconds(50),
            onRetry: (attempt, ex) =>
            {
                // Optional: Log retry attempts
                Console.WriteLine($"Retry attempt {attempt}: {ex.Message}");
            });

        // Assert: Operation eventually succeeded
        attemptCount.Should().Be(3);
    }

    /// <summary>
    /// Example: Using performance measurement utilities.
    /// </summary>
    [Fact]
    public async Task Example_GpuTestHelpers_PerformanceMeasurement()
    {
        // Arrange: Operation to measure
        async Task<int> ExpensiveOperation()
        {
            await Task.Delay(50);
            return 42;
        }

        // Act: Measure execution time
        var (result, elapsed) = await GpuTestHelpers.MeasureAsync(ExpensiveOperation);

        // Assert: Verify timing and result
        result.Should().Be(42);
        elapsed.Should().BeGreaterThan(TimeSpan.FromMilliseconds(40));
        elapsed.Should().BeLessThan(TimeSpan.FromMilliseconds(150));
    }

    /// <summary>
    /// Example: Using benchmark utilities for performance testing.
    /// </summary>
    [Fact]
    public async Task Example_GpuTestHelpers_Benchmark()
    {
        // Arrange: Operation to benchmark
        var counter = 0;
        async Task BenchmarkedOperation()
        {
            counter++;
            await Task.Delay(1);
        }

        // Act: Run benchmark with warmup
        var results = await GpuTestHelpers.BenchmarkAsync(
            BenchmarkedOperation,
            iterations: 10,
            warmupIterations: 3);

        // Assert: Verify benchmark results
        results.Iterations.Should().Be(10);
        results.Min.Should().BeGreaterThan(TimeSpan.Zero);
        results.Average.Should().BeGreaterThan(results.Min);
        results.Max.Should().BeGreaterOrEqualTo(results.Average);
        counter.Should().Be(13); // 10 iterations + 3 warmup
    }

    /// <summary>
    /// Example: Using sorted array assertions.
    /// </summary>
    [Fact]
    public void Example_GpuTestHelpers_SortedArrays()
    {
        // Arrange: Create sorted array
        var sorted = TestDataBuilders.IntArray(100)
            .WithSequentialValues()
            .Build();

        // Act & Assert: Verify array is sorted
        sorted.ShouldBeSorted();
    }

    /// <summary>
    /// Example: Using finite values assertions.
    /// </summary>
    [Fact]
    public void Example_GpuTestHelpers_FiniteValues()
    {
        // Arrange: Create array with finite values
        var finite = TestDataBuilders.FloatArray(100)
            .WithRandomRange(-1000f, 1000f)
            .Build();

        // Act & Assert: Verify all values are finite
        finite.ShouldContainOnlyFiniteValues();
    }

    /// <summary>
    /// Example: Using matrix builders and operations.
    /// </summary>
    [Fact]
    public void Example_TestDataBuilders_Matrices()
    {
        // Arrange: Create various matrix types
        var identity = TestDataBuilders.Matrices.IdentityMatrix(4);
        var sequential = TestDataBuilders.Matrices.SequentialMatrix(3, 4);
        var random = TestDataBuilders.Matrices.RandomMatrix(2, 2, seed: 42);

        // Act: Flatten for GPU processing
        var flattened = TestDataBuilders.Matrices.Flatten(sequential);

        // Assert: Verify matrix characteristics
        identity[0, 0].Should().Be(1.0f);
        identity[0, 1].Should().Be(0.0f);
        sequential[0, 0].Should().Be(0f);
        sequential[2, 3].Should().Be(11f);
        flattened.Length.Should().Be(12);
    }

    /// <summary>
    /// Example: Using common array sizes for standardized testing.
    /// </summary>
    [Theory]
    [InlineData(TestDataBuilders.CommonSizes.Empty)]
    [InlineData(TestDataBuilders.CommonSizes.Single)]
    [InlineData(TestDataBuilders.CommonSizes.Small)]
    [InlineData(TestDataBuilders.CommonSizes.Medium)]
    [InlineData(TestDataBuilders.CommonSizes.PowerOfTwo256)]
    public void Example_TestDataBuilders_CommonSizes(int size)
    {
        // Arrange & Act: Create arrays of standard sizes
        var data = TestDataBuilders.FloatArray(size)
            .WithConstantValue(1.0f)
            .Build();

        // Assert: Verify size
        data.Length.Should().Be(size);
    }

    /// <summary>
    /// Example: Using timeout protection for operations.
    /// </summary>
    [Fact]
    public async Task Example_GpuTestHelpers_TimeoutProtection()
    {
        // Arrange: Operation that should complete quickly
        async Task QuickOperation(System.Threading.CancellationToken ct)
        {
            await Task.Delay(50, ct);
        }

        // Act & Assert: Operation completes within timeout
        await GpuTestHelpers.WithTimeoutAsync(
            QuickOperation,
            timeout: TimeSpan.FromSeconds(1));
    }

    /// <summary>
    /// Example: Using helper utilities for formatting.
    /// </summary>
    [Fact]
    public void Example_GpuTestHelpers_Formatting()
    {
        // Act: Format various values
        var bytes = GpuTestHelpers.FormatBytes(1024L * 1024 * 150);
        var duration = GpuTestHelpers.FormatDuration(TimeSpan.FromMilliseconds(123.45));

        // Assert: Verify formatted strings
        bytes.Should().Contain("MB");
        duration.Should().Contain("ms");
    }
}
