using System;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Orleans;
using Orleans.Hosting;
using Orleans.TestingHost;
using Orleans.GpuBridge.Abstractions;
using Orleans.GpuBridge.Abstractions.Providers;
using Orleans.GpuBridge.Runtime;

namespace Orleans.GpuBridge.Tests.RC2.TestingFramework;

/// <summary>
/// Base test fixture for GPU Bridge tests with Orleans TestCluster support.
/// Provides infrastructure for testing GPU operations with both real and mock GPU providers.
/// </summary>
/// <remarks>
/// This fixture manages the lifecycle of an Orleans TestCluster configured with GPU Bridge services.
/// It supports both mock GPU providers for hardware-independent testing and real GPU providers
/// for integration testing. The fixture ensures proper cleanup of resources and provides
/// helper methods for common test scenarios.
/// </remarks>
public class GpuTestFixture : IAsyncLifetime, IDisposable
{
    private TestCluster? _cluster;
    private bool _disposed;
    private readonly object _disposeLock = new();

    /// <summary>
    /// Gets the Orleans test cluster instance configured with GPU Bridge services.
    /// </summary>
    /// <exception cref="InvalidOperationException">Thrown when cluster is accessed before initialization.</exception>
    public TestCluster Cluster
    {
        get
        {
            ObjectDisposedException.ThrowIf(_disposed, this);
            return _cluster ?? throw new InvalidOperationException("Test cluster not initialized. Call InitializeAsync first.");
        }
    }

    /// <summary>
    /// Gets the Orleans grain factory for creating grain references.
    /// </summary>
    public IGrainFactory GrainFactory => Cluster.GrainFactory;

    /// <summary>
    /// Gets the service provider for the test cluster's primary silo.
    /// </summary>
    public IServiceProvider ServiceProvider => Cluster.ServiceProvider;

    /// <summary>
    /// Gets the GPU Bridge interface from the service provider.
    /// </summary>
    public IGpuBridge GpuBridge => ServiceProvider.GetRequiredService<IGpuBridge>();

    /// <summary>
    /// Gets or sets whether to use a mock GPU provider instead of real hardware.
    /// Default is true for hardware-independent testing.
    /// </summary>
    public bool UseMockProvider { get; set; } = true;

    /// <summary>
    /// Gets or sets the mock GPU provider instance when UseMockProvider is true.
    /// </summary>
    public MockGpuProvider? MockProvider { get; private set; }

    /// <summary>
    /// Gets or sets whether to enable detailed logging for troubleshooting.
    /// Default is false for cleaner test output.
    /// </summary>
    public bool EnableVerboseLogging { get; set; } = false;

    /// <summary>
    /// Gets or sets the number of silos in the test cluster.
    /// Default is 1 for simpler test scenarios.
    /// </summary>
    public int SiloCount { get; set; } = 1;

    /// <summary>
    /// Initializes the test fixture asynchronously.
    /// Creates and configures the Orleans TestCluster with GPU Bridge services.
    /// </summary>
    /// <returns>A task that completes when initialization is finished.</returns>
    public async Task InitializeAsync()
    {
        ObjectDisposedException.ThrowIf(_disposed, this);

        var builder = new TestClusterBuilder(SiloCount);

        // Configure silo options
        builder.AddSiloBuilderConfigurator<TestSiloConfigurator>();

        // Configure client options
        builder.AddClientBuilderConfigurator<TestClientConfigurator>();

        // Store configuration in properties for configurators
        builder.Properties["UseMockProvider"] = UseMockProvider;
        builder.Properties["EnableVerboseLogging"] = EnableVerboseLogging;

        if (UseMockProvider)
        {
            MockProvider = new MockGpuProvider();
            builder.Properties["MockProvider"] = MockProvider;
        }

        _cluster = builder.Build();
        await _cluster.DeployAsync().ConfigureAwait(false);
    }

    /// <summary>
    /// Disposes the test fixture asynchronously.
    /// Stops the Orleans TestCluster and cleans up resources.
    /// </summary>
    /// <returns>A task that completes when disposal is finished.</returns>
    public async Task DisposeAsync()
    {
        if (_disposed)
            return;

        lock (_disposeLock)
        {
            if (_disposed)
                return;
            _disposed = true;
        }

        if (_cluster != null)
        {
            await _cluster.StopAllSilosAsync().ConfigureAwait(false);
            await _cluster.DisposeAsync().ConfigureAwait(false);
        }

        MockProvider?.Dispose();
    }

    /// <summary>
    /// Disposes the test fixture synchronously.
    /// </summary>
    public void Dispose()
    {
        if (_disposed)
            return;

        lock (_disposeLock)
        {
            if (_disposed)
                return;
            _disposed = true;
        }

        if (_cluster != null)
        {
            _cluster.StopAllSilosAsync().GetAwaiter().GetResult();
            _cluster.DisposeAsync().AsTask().GetAwaiter().GetResult();
        }

        MockProvider?.Dispose();
        GC.SuppressFinalize(this);
    }

    /// <summary>
    /// Resets the mock GPU provider to its initial state.
    /// Clears all tracked metrics and resets configuration.
    /// </summary>
    /// <exception cref="InvalidOperationException">Thrown when UseMockProvider is false.</exception>
    public void ResetMockProvider()
    {
        if (!UseMockProvider || MockProvider == null)
            throw new InvalidOperationException("Cannot reset mock provider when UseMockProvider is false.");

        MockProvider.Reset();
    }

    /// <summary>
    /// Configures the mock GPU provider with specific behavior for testing.
    /// </summary>
    /// <param name="configure">Action to configure the mock provider.</param>
    /// <exception cref="InvalidOperationException">Thrown when UseMockProvider is false.</exception>
    public void ConfigureMockProvider(Action<MockGpuProvider> configure)
    {
        if (!UseMockProvider || MockProvider == null)
            throw new InvalidOperationException("Cannot configure mock provider when UseMockProvider is false.");

        configure(MockProvider);
    }

    /// <summary>
    /// Waits for a condition to be met with timeout and retry logic.
    /// Useful for testing asynchronous operations with eventual consistency.
    /// </summary>
    /// <param name="condition">The condition to wait for.</param>
    /// <param name="timeout">Maximum time to wait (default: 30 seconds).</param>
    /// <param name="pollingInterval">Interval between condition checks (default: 100ms).</param>
    /// <returns>A task that completes when the condition is met or timeout occurs.</returns>
    /// <exception cref="TimeoutException">Thrown when the condition is not met within the timeout period.</exception>
    public async Task WaitForConditionAsync(
        Func<bool> condition,
        TimeSpan? timeout = null,
        TimeSpan? pollingInterval = null)
    {
        var actualTimeout = timeout ?? TimeSpan.FromSeconds(30);
        var actualInterval = pollingInterval ?? TimeSpan.FromMilliseconds(100);
        var deadline = DateTime.UtcNow + actualTimeout;

        while (DateTime.UtcNow < deadline)
        {
            if (condition())
                return;

            await Task.Delay(actualInterval).ConfigureAwait(false);
        }

        throw new TimeoutException($"Condition was not met within {actualTimeout.TotalSeconds} seconds.");
    }

    /// <summary>
    /// Silo builder configurator for test scenarios.
    /// </summary>
    private class TestSiloConfigurator : ISiloConfigurator
    {
        public void Configure(ISiloBuilder siloBuilder)
        {
            var properties = siloBuilder.Properties;
            var useMockProvider = (bool)properties["UseMockProvider"];
            var enableVerboseLogging = (bool)properties["EnableVerboseLogging"];

            // Configure logging
            siloBuilder.ConfigureLogging(logging =>
            {
                logging.AddConsole();
                logging.SetMinimumLevel(enableVerboseLogging ? LogLevel.Debug : LogLevel.Warning);
            });

            // Configure GPU Bridge services
            siloBuilder.ConfigureServices(services =>
            {
                if (useMockProvider)
                {
                    var mockProvider = (MockGpuProvider)properties["MockProvider"];
                    services.AddSingleton<IGpuBackendProvider>(mockProvider);
                }

                // Add GPU Bridge services
                services.AddGpuBridge(options =>
                {
                    options.PreferGpu = true;
                    options.EnableMetrics = true;
                });
            });
        }
    }

    /// <summary>
    /// Client builder configurator for test scenarios.
    /// </summary>
    private class TestClientConfigurator : IClientBuilderConfigurator
    {
        public void Configure(IConfiguration configuration, IClientBuilder clientBuilder)
        {
            clientBuilder.ConfigureLogging(logging =>
            {
                logging.AddConsole();
                logging.SetMinimumLevel(LogLevel.Warning);
            });
        }
    }
}
